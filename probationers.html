<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMProb - Probationers Management</title>
    
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1C1C1C 0%, #0E3CBD 100%);
            min-height: 100vh;
            color: #FFFFFF;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 30px;
            background: rgba(28, 28, 28, 0.9);
            border-bottom: 1px solid #259FDE;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            height: 70px;
        }

        .left-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            height: 100%;
        }

        .logo {
            height: 90%;
            width: auto;
            margin-right: 10px;
            filter: drop-shadow(0 0 5px #259FDE);
        }

        .system-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #259FDE;
            letter-spacing: 1px;
        }

        /* Buttons */
        .button-primary, .button-secondary, .button-danger {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .button-primary {
            background-color: #259FDE;
            color: #FFFFFF;
        }

        .button-primary:hover {
            background-color: #1a7fb3;
            box-shadow: 0 0 10px #259FDE;
        }

        .button-secondary {
            background-color: #444444;
            color: #FFFFFF;
        }

        .button-secondary:hover {
            background-color: #666666;
        }
        
        .button-danger {
            background-color: #E74C3C;
            color: #FFFFFF;
        }

        .button-danger:hover {
            background-color: #c0392b;
            box-shadow: 0 0 10px #E74C3C;
        }

        /* Main Content Grid */
        .main-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-bar {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: #FFF;
            width: 300px;
            transition: border-color 0.3s;
        }

        .search-bar:focus {
            border-color: #259FDE;
            outline: none;
        }

        .probationers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Probationer Card */
        .probationer-card {
            background: #282828;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border-left: 5px solid #259FDE;
        }

        .probationer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .name {
            font-size: 1.4em;
            font-weight: 700;
            color: #259FDE;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background-color: #2ECC71;
            color: #1C1C1C;
        }

        .status-badge.inactive {
            background-color: #E74C3C;
            color: #FFFFFF;
        }

        .status-badge.pending {
            background-color: #F39C12;
            color: #1C1C1C;
        }
        
        .status-badge.acknowledged {
            background-color: #259FDE;
            color: #FFFFFF;
        }

        .card-detail {
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .label {
            font-weight: 600;
            color: #AAAAAA;
            margin-right: 5px;
        }

        .recent-violations, .recent-announcements {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #444;
        }

        .list-title {
            font-weight: 700;
            color: #F8F8F8;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .list-title.violations { color: #E74C3C; }
        .list-title.announcements { color: #259FDE; }

        .item-list {
            list-style: none;
            padding-left: 0;
            font-size: 0.85em;
        }

        .item-list li {
            background: #333;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1C1C1C;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.9);
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .close-button {
            color: #AAA;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: #259FDE;
            text-decoration: none;
            cursor: pointer;
        }

        .modal h2 {
            color: #259FDE;
            border-bottom: 2px solid #259FDE;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #AAAAAA;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: #FFF;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-content ul {
            list-style-type: none;
            padding: 0;
        }
        
        .modal-content li {
            background-color: #282828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 3px solid #E74C3C;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s;
        }
        
        .violation-item {
            cursor: pointer; /* To indicate it's interactive for long-press */
            border-left: 3px solid #E74C3C;
        }
        
        .violation-item:active {
            background-color: #3A3A3A; /* Feedback on press */
        }
        
        .announcement-item {
            border-left: 3px solid #259FDE;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .announcement-item .announcement-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .announcement-item .announcement-date {
            font-size: 0.8em;
            color: #AAAAAA;
            margin-top: 5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }
            .system-title {
                font-size: 1.2em;
            }
            .main-content {
                padding: 15px;
            }
            .search-bar {
                width: 100%;
                margin-top: 10px;
            }
            .grid-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .probationers-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>

    <header class="header">
        <div class="left-section">
            <div class="system-title">EMProb - Probationers Management</div>
        </div>
        <div class="right-section">
            <button class="button-primary" onclick="openModal('add')">Add New Probationer</button>
        </div>
    </header>

    <main class="main-content">
        <div class="grid-header">
            <input type="text" id="searchProbationer" class="search-bar" placeholder="Search by Name or Device ID...">
        </div>
        
        <div id="probationersGrid" class="probationers-grid">
            </div>
    </main>

    <div id="probationerModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Add New Probationer</h2>
            <form id="probationerForm">
                <input type="hidden" id="probationerId">
                
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-group">
                    <label for="device_id">Device ID</label>
                    <input type="text" id="device_id" required>
                </div>
                
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="enrollment_date">Enrollment Date</label>
                    <input type="date" id="enrollment_date" required>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="button-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="button-primary" id="saveButton">Save</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="violationsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" onclick="closeViolationsModal()">&times;</span>
            <h2 id="violationsModalTitle">Violations for [Name]</h2>
            <input type="hidden" id="currentProbationerIdViolations">
            
            <form id="addViolationForm" style="margin-bottom: 20px; padding: 15px; border: 1px solid #444; border-radius: 5px; background: #222;">
                <h3 style="color: #E74C3C; margin-bottom: 10px;">Add New Violation</h3>
                <div class="form-group">
                    <input type="text" id="violationDescription" placeholder="Violation Description" required>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <input type="date" id="violationDate" style="flex-grow: 1;" required>
                    <button type="submit" class="button-danger">Add Violation</button>
                </div>
            </form>
            
            <h3 style="color: #F8F8F8; margin-bottom: 10px;">Violation List (Long-press to Delete)</h3>
            <ul id="violationsList">
                </ul>
        </div>
    </div>

    <div id="announcementsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" onclick="closeAnnouncementsModal()">&times;</span>
            <h2 id="announcementsModalTitle">Announcements for [Name]</h2>
            <input type="hidden" id="currentProbationerIdAnnouncements">
            
            <div style="margin-bottom: 20px; display: flex; justify-content: flex-end;">
                <button class="button-primary" onclick="openAddAnnouncementModal()">Add New Announcement</button>
            </div>

            <ul id="announcementsList">
                </ul>
        </div>
    </div>

    <div id="announcementModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button" onclick="closeAddAnnouncementModal()">&times;</span>
            <h2>Create Announcement</h2>
            <form id="announcementForm">
                <div class="form-group">
                    <label for="announcementTitle">Title</label>
                    <input type="text" id="announcementTitle" required>
                </div>
                <div class="form-group">
                    <label for="announcementMessage">Message</label>
                    <textarea id="announcementMessage" rows="4" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="button-secondary" onclick="closeAddAnnouncementModal()">Cancel</button>
                    <button type="submit" class="button-primary">Post Announcement</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-button" onclick="closeConfirmModal()">&times;</span>
            <h2 id="confirmModalTitle">Confirm Action</h2>
            <p id="confirmModalMessage" style="margin: 20px 0;"></p>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="button-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button id="confirmActionButton" class="button-danger">Confirm</button>
            </div>
        </div>
    </div>


    <script>
        // --- Firebase Configuration and Initialization ---
        // REPLACE WITH YOUR ACTUAL CONFIGURATION
        const firebaseConfig = {
             apiKey: "YOUR_API_KEY",
             authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
             databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
             projectId: "YOUR_PROJECT_ID",
             storageBucket: "YOUR_PROJECT_ID.appspot.com",
             messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
             appId: "YOUR_APP_ID"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const database = firebase.database;
        const getDatabase = database.getDatabase;
        const ref = database.ref;
        const onValue = database.onValue;
        const push = database.push;
        const set = database.set;
        const update = database.update;
        const remove = database.remove;

        let probationersData = {}; // Cache for probationer data

        // --- New Feature Functions (Acknowledge/Pending Toggle & Delete Violation) ---
        
        // Function to close the new generic confirmation modal
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // Function to open the generic confirmation modal
        function showConfirmModal(title, message, actionCallback, isDanger = true) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').innerHTML = message;
            
            const confirmButton = document.getElementById('confirmActionButton');
            
            // Set button style (danger for deletion, primary for status change)
            confirmButton.classList.remove('button-danger', 'button-primary');
            confirmButton.classList.add(isDanger ? 'button-danger' : 'button-primary');
            
            // **IMPORTANT:** Clone and replace the button to remove old event listeners
            const oldConfirmButton = confirmButton;
            const newConfirmButton = oldConfirmButton.cloneNode(true);
            oldConfirmButton.parentNode.replaceChild(newConfirmButton, oldConfirmButton);

            // Attach the new action function to the button
            newConfirmButton.onclick = () => {
                actionCallback();
                closeConfirmModal();
            };

            document.getElementById('confirmModal').style.display = 'flex';
        }

        // Feature 1: Toggle Announcement Status in Firebase
        function toggleAnnouncementStatus(probationerId, announcementId, currentStatus) {
            // Determine the new status
            const newStatus = currentStatus === 'pending' ? 'acknowledged' : 'pending';
            const db = getDatabase();
            const updatePath = `probationers/${probationerId}/announcements/${announcementId}`;

            update(ref(db, updatePath), { status: newStatus })
                .catch(error => {
                    console.error("Error updating announcement status: ", error);
                    alert("Failed to update status. Check console for details.");
                });
        }

        // Feature 2: Delete a Violation in Firebase
        function deleteViolation(probationerId, violationId) {
            const db = getDatabase();
            const violationRef = ref(db, `probationers/${probationerId}/violations/${violationId}`);
            
            remove(violationRef)
                .catch(error => {
                    console.error("Error deleting violation: ", error);
                    alert("Failed to delete violation. Check console for details.");
                });
        }


        // --- Existing Modal Functions ---

        function openModal(mode, probationer = null) {
            const modal = document.getElementById('probationerModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('probationerForm');
            
            if (mode === 'add') {
                title.textContent = 'Add New Probationer';
                form.reset();
                document.getElementById('probationerId').value = '';
            } else if (mode === 'edit' && probationer) {
                title.textContent = `Edit ${probationer.name}`;
                document.getElementById('probationerId').value = probationer.id;
                document.getElementById('name').value = probationer.name;
                document.getElementById('device_id').value = probationer.device_id;
                document.getElementById('status').value = probationer.status;
                document.getElementById('enrollment_date').value = probationer.enrollment_date;
            }
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('probationerModal').style.display = 'none';
        }

        function openViolationsModal(probationer) {
            document.getElementById('violationsModalTitle').textContent = `Violations for ${probationer.name}`;
            document.getElementById('currentProbationerIdViolations').value = probationer.id;
            renderViolations(probationer.id, probationer.violations || {});
            document.getElementById('violationsModal').style.display = 'flex';
        }

        function closeViolationsModal() {
            document.getElementById('violationsModal').style.display = 'none';
        }

        function openAnnouncementsModal(probationer) {
            document.getElementById('announcementsModalTitle').textContent = `Announcements for ${probationer.name}`;
            document.getElementById('currentProbationerIdAnnouncements').value = probationer.id;
            renderAnnouncements(probationer.id, probationer.announcements || {});
            document.getElementById('announcementsModal').style.display = 'flex';
        }

        function closeAnnouncementsModal() {
            document.getElementById('announcementsModal').style.display = 'none';
        }
        
        function openAddAnnouncementModal() {
            document.getElementById('announcementForm').reset();
            document.getElementById('announcementModal').style.display = 'flex';
        }
        
        function closeAddAnnouncementModal() {
            document.getElementById('announcementModal').style.display = 'none';
        }


        // --- CRUD and Render Functions ---

        function saveProbationer(e) {
            e.preventDefault();

            const id = document.getElementById('probationerId').value;
            const name = document.getElementById('name').value;
            const device_id = document.getElementById('device_id').value;
            const status = document.getElementById('status').value;
            const enrollment_date = document.getElementById('enrollment_date').value;

            const probationerData = { name, device_id, status, enrollment_date };
            const db = getDatabase();

            if (id) {
                // Update
                update(ref(db, 'probationers/' + id), probationerData);
            } else {
                // Add new (push generates a new ID)
                const newProbationerRef = push(ref(db, 'probationers'));
                set(newProbationerRef, { ...probationerData, id: newProbationerRef.key });
            }

            closeModal();
        }

        function deleteProbationer(probationerId) {
             showConfirmModal(
                "Confirm Deletion",
                "Are you sure you want to delete this probationer? This cannot be undone.",
                () => {
                    const db = getDatabase();
                    remove(ref(db, 'probationers/' + probationerId));
                }
            );
        }

        function addViolation(e) {
            e.preventDefault();
            const probationerId = document.getElementById('currentProbationerIdViolations').value;
            const description = document.getElementById('violationDescription').value;
            const date = document.getElementById('violationDate').value;
            
            if (!description || !date) return;

            const db = getDatabase();
            const newViolationRef = push(ref(db, `probationers/${probationerId}/violations`));
            
            const violationData = {
                description: description,
                date: date,
                timestamp: Date.now()
            };
            
            set(newViolationRef, violationData).then(() => {
                document.getElementById('violationDescription').value = '';
                document.getElementById('violationDate').value = '';
            });
        }
        
        function postAnnouncement(e) {
            e.preventDefault();
            const probationerId = document.getElementById('currentProbationerIdAnnouncements').value;
            const title = document.getElementById('announcementTitle').value;
            const message = document.getElementById('announcementMessage').value;

            if (!title || !message) return;

            const db = getDatabase();
            const newAnnouncementRef = push(ref(db, `probationers/${probationerId}/announcements`));
            
            const announcementData = {
                title: title,
                message: message,
                date: new Date().toISOString().split('T')[0], // Current date
                status: 'pending', // Initial status is pending
                timestamp: Date.now()
            };
            
            set(newAnnouncementRef, announcementData).then(() => {
                closeAddAnnouncementModal();
            });
        }
        
        function renderProbationers(probationers) {
            const grid = document.getElementById('probationersGrid');
            grid.innerHTML = '';
            
            probationersData = probationers; // Update cache

            Object.keys(probationers).forEach(id => {
                const probationer = probationers[id];
                probationer.id = id;
                
                const card = document.createElement('div');
                card.classList.add('probationer-card');
                card.onclick = () => openModal('edit', probationer); // Edit on main click
                
                const violations = probationer.violations ? Object.entries(probationer.violations) : [];
                const announcements = probationer.announcements ? Object.entries(probationer.announcements) : [];
                
                // Sort announcements by timestamp descending and take up to 3 for recent
                const sortedAnnouncements = announcements
                    .sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0))
                    .slice(0, 3);

                let recentAnnouncementsHTML = sortedAnnouncements.length > 0 ? 
                    `<div class="recent-announcements">
                        <div class="list-title announcements">Recent Announcements (${announcements.length} total)</div>
                        <ul class="item-list">` : '';

                sortedAnnouncements.forEach(([key, ann]) => {
                    // NEW: Status badge creation and click handler for the card view
                    const statusClass = ann.status || 'pending';
                    const statusText = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
                    
                    recentAnnouncementsHTML += `
                        <li style="border-left: 3px solid ${statusClass === 'pending' ? '#F39C12' : '#259FDE'};">
                            <span>${ann.title}</span>
                            <span class="status-badge ${statusClass}" 
                                style="cursor: pointer;"
                                onclick="event.stopPropagation(); handleCardStatusClick('${id}', '${key}', '${ann.title}', '${statusClass}');">
                                ${statusText}
                            </span>
                        </li>
                    `;
                });
                
                if (sortedAnnouncements.length > 0) {
                    recentAnnouncementsHTML += `</ul></div>`;
                }


                card.innerHTML = `
                    <div class="card-header">
                        <span class="name">${probationer.name}</span>
                        <span class="status-badge ${probationer.status}">${probationer.status.toUpperCase()}</span>
                    </div>
                    <div class="card-detail"><span class="label">Device ID:</span> ${probationer.device_id}</div>
                    <div class="card-detail"><span class="label">Enrollment:</span> ${probationer.enrollment_date}</div>
                    
                    <div class="recent-violations">
                        <div class="list-title violations">Recent Violations (${violations.length} total)</div>
                        <ul class="item-list">
                            ${violations.slice(0, 3).map(([, viol]) => 
                                `<li style="border-left: 3px solid #E74C3C;">
                                    ${viol.description} 
                                    <span style="font-size: 0.75em; color: #777;">(${viol.date})</span>
                                </li>`).join('')}
                        </ul>
                        <div class="modal-actions" style="margin-top: 10px;">
                            <button class="button-secondary" onclick="event.stopPropagation(); openViolationsModal(probationerersData['${id}'])">Manage Violations</button>
                        </div>
                    </div>
                    
                    ${recentAnnouncementsHTML}
                    <div class="modal-actions" style="margin-top: 10px; ${sortedAnnouncements.length === 0 ? 'border-top: 1px dashed #444; padding-top: 15px;' : ''}">
                        <button class="button-secondary" onclick="event.stopPropagation(); openAnnouncementsModal(probationersData['${id}'])">Manage Announcements</button>
                        <button class="button-danger" onclick="event.stopPropagation(); deleteProbationer('${id}')">Delete</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Helper function for the card status click to use the generic modal
        function handleCardStatusClick(probationerId, announcementId, title, currentStatus) {
            const nextStatus = currentStatus === 'pending' ? 'Acknowledged' : 'Pending';
            const modalTitle = `Change Status to ${nextStatus}?`;
            const message = `Are you sure you want to change the status of recent announcement **'${title}'** to **${nextStatus}**?`;
            
            showConfirmModal(
                modalTitle, 
                message, 
                () => toggleAnnouncementStatus(probationerId, announcementId, currentStatus), 
                false // Not a danger action
            );
        }

        function renderViolations(probationerId, violations) {
            const list = document.getElementById('violationsList');
            list.innerHTML = '';
            
            const violationEntries = Object.entries(violations).sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0));

            violationEntries.forEach(([violationId, violation]) => {
                const violationItem = document.createElement('li');
                violationItem.classList.add('violation-item');
                violationItem.innerHTML = `
                    <span>${violation.description}</span>
                    <span style="font-size: 0.8em; color: #AAA;">${violation.date}</span>
                `;

                // --- NEW FEATURE: Long Press Deletion Logic ---
                let pressTimer;
                const LONG_PRESS_DURATION = 500; // 0.5 seconds

                const handlePressStart = (e) => {
                    // Prevent default touch behavior (e.g., scrolling)
                    if (e.type.startsWith('touch')) {
                        e.preventDefault(); 
                    }
                    
                    // Start the timer
                    pressTimer = setTimeout(() => {
                        // Long press detected: Show confirmation modal
                        const title = "Confirm Violation Deletion";
                        const message = `Are you sure you want to delete the violation: <strong>${violation.description}</strong>? This action cannot be undone.`;
                        
                        showConfirmModal(
                            title, 
                            message, 
                            () => deleteViolation(probationerId, violationId),
                            true // Danger action
                        );
                        
                    }, LONG_PRESS_DURATION);
                };

                const handlePressEnd = () => {
                    // Clear the timer if the press ends before the duration
                    clearTimeout(pressTimer);
                };

                // Attach listeners for both mouse (desktop) and touch (mobile)
                violationItem.addEventListener('mousedown', handlePressStart);
                violationItem.addEventListener('touchstart', handlePressStart);
                violationItem.addEventListener('mouseup', handlePressEnd);
                violationItem.addEventListener('mouseleave', handlePressEnd); // If mouse moves away while pressing
                violationItem.addEventListener('touchend', handlePressEnd);
                violationItem.addEventListener('touchcancel', handlePressEnd);
                // --- END NEW FEATURE ---

                list.appendChild(violationItem);
            });

            if (violationEntries.length === 0) {
                list.innerHTML = '<li style="border-left: none;">No violations recorded.</li>';
            }
        }
        
        function renderAnnouncements(probationerId, announcements) {
            const list = document.getElementById('announcementsList');
            list.innerHTML = '';
            
            const announcementEntries = Object.entries(announcements).sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0));

            announcementEntries.forEach(([announcementId, announcement]) => {
                const status = announcement.status || 'pending';
                const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                
                const announcementItem = document.createElement('li');
                announcementItem.classList.add('announcement-item');
                announcementItem.innerHTML = `
                    <div class="announcement-header">
                        <span style="font-weight: 700;">${announcement.title}</span>
                        <span class="status-badge ${status}" 
                            style="cursor: pointer;"
                            onclick="handleModalStatusClick('${probationerId}', '${announcementId}', '${announcement.title}', '${status}');">
                            ${statusText}
                        </span>
                    </div>
                    <p style="margin-bottom: 5px; font-size: 0.9em; color: #CCC;">${announcement.message}</p>
                    <span class="announcement-date">Date: ${announcement.date}</span>
                `;

                list.appendChild(announcementItem);
            });

            if (announcementEntries.length === 0) {
                list.innerHTML = '<li style="border-left: none;">No announcements posted.</li>';
            }
        }
        
        // Helper function for the modal status click to use the generic modal
        function handleModalStatusClick(probationerId, announcementId, title, currentStatus) {
            const nextStatus = currentStatus === 'pending' ? 'Acknowledged' : 'Pending';
            const modalTitle = `Change Status to ${nextStatus}?`;
            const message = `Are you sure you want to change the status of announcement **'${title}'** to **${nextStatus}**?`;
            
            showConfirmModal(
                modalTitle, 
                message, 
                () => toggleAnnouncementStatus(probationerId, announcementId, currentStatus), 
                false // Not a danger action
            );
        }

        // --- Event Listeners and Initializers ---

        function initApplication() {
            const db = getDatabase();
            const probationersRef = ref(db, 'probationers');
            
            // Listen for data changes in Firebase
            onValue(probationersRef, (snapshot) => {
                const data = snapshot.val() || {};
                renderProbationers(data);
                
                // Re-render violations/announcements if their modals are open
                const currentProbationerIdViolations = document.getElementById('currentProbationerIdViolations').value;
                if (document.getElementById('violationsModal').style.display === 'flex' && currentProbationerIdViolations) {
                    openViolationsModal(probationersData[currentProbationerIdViolations]);
                }
                const currentProbationerIdAnnouncements = document.getElementById('currentProbationerIdAnnouncements').value;
                 if (document.getElementById('announcementsModal').style.display === 'flex' && currentProbationerIdAnnouncements) {
                    openAnnouncementsModal(probationersData[currentProbationerIdAnnouncements]);
                }
            });
        }

        function setupEventListeners() {
            // Main form submission for Add/Edit Probationer
            document.getElementById('probationerForm').addEventListener('submit', saveProbationer);
            
            // Search filter
            document.getElementById('searchProbationer').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                const filtered = Object.keys(probationersData)
                    .filter(id => 
                        probationersData[id].name.toLowerCase().includes(query) || 
                        probationersData[id].device_id.toLowerCase().includes(query)
                    )
                    .reduce((obj, key) => {
                        obj[key] = probationersData[key];
                        return obj;
                    }, {});
                renderProbationers(filtered);
            });
            
            // Form submission for Add Violation
            document.getElementById('addViolationForm').addEventListener('submit', addViolation);

            // Form submission for Post Announcement
            document.getElementById('announcementForm').addEventListener('submit', postAnnouncement);

            // Close modals on outside click
            const modals = ['probationerModal', 'violationsModal', 'announcementsModal', 'announcementModal', 'confirmModal'];
            modals.forEach(id => {
                document.getElementById(id).addEventListener('click', (e) => {
                    if (e.target.id === id) {
                        if (id === 'probationerModal') closeModal();
                        if (id === 'violationsModal') closeViolationsModal();
                        if (id === 'announcementsModal') closeAnnouncementsModal();
                        if (id === 'announcementModal') closeAddAnnouncementModal();
                        if (id === 'confirmModal') closeConfirmModal();
                    }
                });
            });
            
            // Close modals with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('probationerModal').style.display === 'flex') {
                        closeModal();
                    }
                    // REPLACED old closeDeleteModal() with closeConfirmModal()
                    if (document.getElementById('confirmModal').style.display === 'flex') { 
                        closeConfirmModal();
                    }
                    if (document.getElementById('violationsModal').style.display === 'flex') {
                        closeViolationsModal();
                    }
                    if (document.getElementById('announcementsModal').style.display === 'flex') {
                        closeAnnouncementsModal();
                    }
                    if (document.getElementById('announcementModal').style.display === 'flex') {
                        closeAddAnnouncementModal();
                    }
                }
            });
        }

        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initApplication();
            setupEventListeners();
        });
    </script>
</body>
</html>
